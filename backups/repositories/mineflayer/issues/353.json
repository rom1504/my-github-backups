{
    "assignee": null,
    "body": "Attempting to use latest mineflayer (c3f67f9 from git) with latest [Glowstone++](https://github.com/GlowstonePlusPlus/GlowstonePlusPlus) ~~(65111e) from git), usually I hit another issue and cannot login: https://github.com/GlowstonePlusPlus/GlowstonePlusPlus/issues/146~~ (update: no longer hit this issue with build 511) - but after retrying several times, ~~sometimes~~ consistently mineflayer gets further but then crashes in the \"inventory\" plugin:\r\n\r\n```\r\nmineflayer $ NODE_DEBUG=minecraft-protocol node examples/echo.js  localhost 25565\r\nMC-PROTO: 64949 Old-styling packet\r\nMC-PROTO: 64949 writing packetId handshaking.set_protocol (0x0)\r\nMC-PROTO: 64949 { protocolVersion: 47,\r\n  serverHost: 'localhost',\r\n  serverPort: 25565,\r\n  nextState: 2 }\r\nMC-PROTO: 64949 Old-styling packet\r\nMC-PROTO: 64949 writing packetId login.login_start (0x0)\r\nMC-PROTO: 64949 { username: 'echo' }\r\nMC-PROTO: 64949 read packetId login.compress (0x3)\r\nMC-PROTO: 64949 { id: 3, state: 'login', threshold: 256 }\r\nMC-PROTO: 64949 read packetId login.success (0x2)\r\nMC-PROTO: 64949 { id: 2,\r\n  state: 'login',\r\n  uuid: 'c39fa4c6-85a3-3582-8167-db3805dbe851',\r\n  username: 'echo' }\r\nMC-PROTO: 64949 read packetId play.window_items (0x30)\r\nMC-PROTO: 64949 { id: 48,\r\n  state: 'play',\r\n  windowId: 0,\r\n  count: 45,\r\n  items: \r\n   [ { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -1 },\r\n     { blockId: -\r\n/Users/admin/games/voxeljs/mineflayer/lib/plugins/inventory.js:279\r\n    bot.entity.heldItem = bot.heldItem;\r\n                        ^\r\n\r\nTypeError: Cannot set property 'heldItem' of undefined\r\n    at updateHeldItem (/Users/admin/games/voxeljs/mineflayer/lib/plugins/inventory.js:279:25)\r\n    at Client.<anonymous> (/Users/admin/games/voxeljs/mineflayer/lib/plugins/inventory.js:446:5)\r\n    at emitOne (events.js:77:13)\r\n    at Client.emit (events.js:169:7)\r\n    at afterParse (/Users/admin/games/voxeljs/node-minecraft-protocol/dist/client.js:97:10)\r\n    at parseNewStylePacket (/Users/admin/games/voxeljs/node-minecraft-protocol/dist/protocol.js:1080:5)\r\n    at prepareParse (/Users/admin/games/voxeljs/node-minecraft-protocol/dist/client.js:113:9)\r\n    at Socket.<anonymous> (/Users/admin/games/voxeljs/node-minecraft-protocol/dist/client.js:124:5)\r\n    at emitOne (events.js:77:13)\r\n    at Socket.emit (events.js:169:7)\r\n```\r\n\r\nunsure if this is a client (mineflayer) or server (Glowstone++) bug, but at first glance it seems to me to be a possible timing/synchronization or packet ordering issue? \r\n\r\n(Originally saw this when using mineflayer through https://github.com/vogonistic/mineflayer-voxel/pull/1)",
    "closed_at": "2016-01-10T01:56:22Z",
    "comment_data": [
        {
            "body": "bot.entity is defined when the login packet (http://prismarinejs.github.io/minecraft-data/?d=protocol#toClient_login http://wiki.vg/Protocol#Join_Game ) is received (https://github.com/PrismarineJS/mineflayer/blob/master/lib/plugins/entities.js#L67)\r\n\r\nit seems like glowstone send window_items before this packet.\r\n\r\nTo handle this we'd have to define bot.entity before I guess, but that would be a bit weird because we don't know the entity id before getting that login packet.\r\n\r\nI guess I'll try running mineflayer on glowstone and try some things.",
            "created_at": "2016-01-07T11:34:42Z",
            "html_url": "https://github.com/PrismarineJS/mineflayer/issues/353#issuecomment-169636457",
            "id": 169636457,
            "issue_url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/353",
            "updated_at": "2016-01-07T11:34:42Z",
            "url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/comments/169636457",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2346494?v=3",
                "events_url": "https://api.github.com/users/rom1504/events{/privacy}",
                "followers_url": "https://api.github.com/users/rom1504/followers",
                "following_url": "https://api.github.com/users/rom1504/following{/other_user}",
                "gists_url": "https://api.github.com/users/rom1504/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/rom1504",
                "id": 2346494,
                "login": "rom1504",
                "organizations_url": "https://api.github.com/users/rom1504/orgs",
                "received_events_url": "https://api.github.com/users/rom1504/received_events",
                "repos_url": "https://api.github.com/users/rom1504/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/rom1504/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/rom1504/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/rom1504"
            }
        },
        {
            "body": "Dug into this some more, I believe it is a Glowstone++ server bug.\r\n\r\nIt sends window_items, login, and then another window_items. The first window_items appears to be an error, because it is called in the constructor and is sent in join() anyway. Removing it allows mineflayer to login, and we still get updated inventories: https://github.com/GlowstonePlusPlus/GlowstonePlusPlus/pull/147 - if my analysis is correct (awaiting feedback on the Glowstone++ PR), then this issue on mineflayer can be closed. ",
            "created_at": "2016-01-09T05:08:56Z",
            "html_url": "https://github.com/PrismarineJS/mineflayer/issues/353#issuecomment-170195730",
            "id": 170195730,
            "issue_url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/353",
            "updated_at": "2016-01-09T05:08:56Z",
            "url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/comments/170195730",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5897956?v=3",
                "events_url": "https://api.github.com/users/deathcap/events{/privacy}",
                "followers_url": "https://api.github.com/users/deathcap/followers",
                "following_url": "https://api.github.com/users/deathcap/following{/other_user}",
                "gists_url": "https://api.github.com/users/deathcap/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/deathcap",
                "id": 5897956,
                "login": "deathcap",
                "organizations_url": "https://api.github.com/users/deathcap/orgs",
                "received_events_url": "https://api.github.com/users/deathcap/received_events",
                "repos_url": "https://api.github.com/users/deathcap/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/deathcap/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/deathcap/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/deathcap"
            }
        },
        {
            "body": "Fixed in Glowstone++ https://github.com/GlowstonePlusPlus/GlowstonePlusPlus/pull/147",
            "created_at": "2016-01-10T01:56:22Z",
            "html_url": "https://github.com/PrismarineJS/mineflayer/issues/353#issuecomment-170300269",
            "id": 170300269,
            "issue_url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/353",
            "updated_at": "2016-01-10T01:56:22Z",
            "url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/comments/170300269",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5897956?v=3",
                "events_url": "https://api.github.com/users/deathcap/events{/privacy}",
                "followers_url": "https://api.github.com/users/deathcap/followers",
                "following_url": "https://api.github.com/users/deathcap/following{/other_user}",
                "gists_url": "https://api.github.com/users/deathcap/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/deathcap",
                "id": 5897956,
                "login": "deathcap",
                "organizations_url": "https://api.github.com/users/deathcap/orgs",
                "received_events_url": "https://api.github.com/users/deathcap/received_events",
                "repos_url": "https://api.github.com/users/deathcap/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/deathcap/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/deathcap/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/deathcap"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/353/comments",
    "created_at": "2016-01-07T07:55:32Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5897956?v=3",
                "events_url": "https://api.github.com/users/deathcap/events{/privacy}",
                "followers_url": "https://api.github.com/users/deathcap/followers",
                "following_url": "https://api.github.com/users/deathcap/following{/other_user}",
                "gists_url": "https://api.github.com/users/deathcap/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/deathcap",
                "id": 5897956,
                "login": "deathcap",
                "organizations_url": "https://api.github.com/users/deathcap/orgs",
                "received_events_url": "https://api.github.com/users/deathcap/received_events",
                "repos_url": "https://api.github.com/users/deathcap/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/deathcap/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/deathcap/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/deathcap"
            },
            "commit_id": "bc6c8a47671e044201d767b58a7476852596afed",
            "commit_url": "https://api.github.com/repos/GlowstonePlusPlus/GlowstonePlusPlus/commits/bc6c8a47671e044201d767b58a7476852596afed",
            "created_at": "2016-01-09T05:04:38Z",
            "event": "referenced",
            "id": 510106318,
            "url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/events/510106318"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5897956?v=3",
                "events_url": "https://api.github.com/users/deathcap/events{/privacy}",
                "followers_url": "https://api.github.com/users/deathcap/followers",
                "following_url": "https://api.github.com/users/deathcap/following{/other_user}",
                "gists_url": "https://api.github.com/users/deathcap/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/deathcap",
                "id": 5897956,
                "login": "deathcap",
                "organizations_url": "https://api.github.com/users/deathcap/orgs",
                "received_events_url": "https://api.github.com/users/deathcap/received_events",
                "repos_url": "https://api.github.com/users/deathcap/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/deathcap/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/deathcap/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/deathcap"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2016-01-10T01:56:22Z",
            "event": "closed",
            "id": 510344492,
            "url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/events/510344492"
        }
    ],
    "events_url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/353/events",
    "html_url": "https://github.com/PrismarineJS/mineflayer/issues/353",
    "id": 125344196,
    "labels": [],
    "labels_url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/353/labels{/name}",
    "locked": false,
    "milestone": null,
    "number": 353,
    "state": "closed",
    "title": "TypeError: Cannot set property 'heldItem' of undefined in inventory plugin - occasionally occurs when connecting to Glowstone++ server",
    "updated_at": "2016-01-10T01:56:22Z",
    "url": "https://api.github.com/repos/PrismarineJS/mineflayer/issues/353",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5897956?v=3",
        "events_url": "https://api.github.com/users/deathcap/events{/privacy}",
        "followers_url": "https://api.github.com/users/deathcap/followers",
        "following_url": "https://api.github.com/users/deathcap/following{/other_user}",
        "gists_url": "https://api.github.com/users/deathcap/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/deathcap",
        "id": 5897956,
        "login": "deathcap",
        "organizations_url": "https://api.github.com/users/deathcap/orgs",
        "received_events_url": "https://api.github.com/users/deathcap/received_events",
        "repos_url": "https://api.github.com/users/deathcap/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/deathcap/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/deathcap/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/deathcap"
    }
}